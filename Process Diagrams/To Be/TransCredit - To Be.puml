@startuml
title TransCredit New System Workflow - Desired State

start

:Receive Agent Report;
:Store in PlateauGroup.Web Database;

:Enhanced Certificate Search;
note right
  New Search Capabilities:
  - First/Last Name (wildcards)
  - Birthday
  - SSN
  - Claim Number
end note

:Input Certificate Data;
:Check Health Questions Status;
note right
  AUTOMATED: System checks Health Questions:
  - UwCode 1 = Health Questions answered
  - UwCode 3 = Health Questions NOT answered
  - DISABILITY: Requires ALL HQs answered
  - Flags certificates requiring agent follow-up
end note

:Run Snapshot Validation;
note right
  AUTOMATED: System validates all certificates for:
  - Customer age limits validation
  - Premium calculation accuracy
  - Coverage amount verification
  - Refund method (pro-rata vs Rule 78)
  - Platform provider errors
  - Printing errors detection
  - Multiple policy violations
end note

:Run Over Limits Check;
note right
  AUTOMATED: System checks coverage limits:
  - Uses cumulative coverage tracking
  - Checks if customer exceeds agent limits
  - Validates against agent's maximum coverage
  - Identifies multiple active policies
end note

if (Errors found?) then (yes)
  :Create CertError records;
  note right
    AUTOMATED: System creates error records:
    - Certificate validation errors
    - Health questions missing
    - Coverage limit violations
    - Premium calculation errors
  end note
  
  :Generate Agent Communication;
  
  :Send Email to Agent;
  note right
    Email includes:
    - AgentReportEmail ID
    - Spreadsheet attachments
    - DMZ website link
    - Specific certificates to fix
  end note
  
  :Copy Data to DMZ Database;
  :Store AgentReportEmail record;
  
  :Agent receives email;
  :Agent logs into DMZ Website;
  note right
    DMZ Features:
    - Auth0 MFA authentication
    - View pending reports
    - Edit certificates
    - Submit corrections
  end note
  
  :Agent makes corrections;
  :DMZ system validates changes;
  
  if (Agent corrections valid?) then (yes)
    :Insert OpsLog message;
    :Notify PlateauGroup.Web user;
    
    :User reviews changes;
    if (Changes approved?) then (yes)
      :Update apsPlateau tables;
      :Sync DMZ changes;
    else (no)
      :Request additional corrections;
    endif
  else (no)
    :Request agent to fix errors;
  endif
  
  :Monitor Inbound Email;
  if (Email contains AgentReportEmail ID?) then (yes)
    :Parse and store response;
  else (no)
    :Search for matching outbound email;
    if (Match found?) then (yes)
      :Link responses;
    else (no)
      :Reply to agent with instructions;
      :Forward to user for manual review;
    endif
  endif
  
else (no)
  :No Validation Errors Found;
endif

if (Coverage limits exceeded?) then (yes)
  :AUTOMATED: System flags for review;
  :Contact Agent for Verification;
  note right
    AUTOMATED: System contacts agent:
    - Multiple policies detected
    - Coverage limits exceeded
    - Verification required for old policies
  end note
  
  if (Multiple policies active?) then (yes)
    :Reduce New Policy Coverage;
    note right
      AUTOMATED: System calculates:
      - Maximum allowed coverage
      - Based on agent's limits
      - Reduces new policy coverage
    end note
    
    :Notify Customer of Reduction;
    note right
      AUTOMATED: System generates:
      - Legal notification letter
      - Benefit reduction explanation
      - Premium adjustment notice
    end note
  else (no)
    :Agent can have this new policy;
    note right
      System allows new policy,
      agent will cancel old if needed
    end note
  endif
else (no)
  :Within Coverage Limits;
endif

:Balance Report and Remittance;
note right
  Balancing Process:
  - Compare Report vs Remittance
  - Validate against CertMaster
  - Financial reconciliation
end note

if (Balanced?) then (yes)
  :Complete Report Processing;
  :Generate final documentation;
else (no)
  :Adjust balances;
  :Create adjustment records;
endif

:Log All Certificate Changes;
note right
  Audit Logging:
  - Every change tracked
  - Reason required
  - User and timestamp
  - Old/New values
end note

:Generate Communication Summary;
:Display on Agent Report Tab;

:Clean up DMZ Data;
note right
  After report completion:
  - Delete DMZ certificate records
  - Delete agent report records
  - Maintain audit trail
end note

stop

@enduml
